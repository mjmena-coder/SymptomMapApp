<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Symptom Mapper v1.0.0.8</title>
    <style>
        :root { --bg: #f8fafc; --primary: #2563eb; --text: #0f172a; --stroke: #334155; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .config-row { background: white; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; width: 100%; max-width: 320px; font-size: 13px; margin-bottom: 10px; }
        .input-mini { width: 50px; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; }
        .log-card { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--primary); width: 100%; max-width: 320px; box-sizing: border-box; position: relative; }
        #status-log { width: 100%; max-width: 320px; height: 60px; font-size: 10px; font-family: monospace; background: #000; color: #0f0; padding: 5px; border-radius: 5px; overflow-y: auto; margin-top: 10px; }
        .debug-timer { display: block; font-size: 0.75rem; color: #ef4444; font-weight: bold; margin-top: 4px; }
    </style>
</head>
<body>

    <h2 style="margin:0">Symptom Mapper</h2>
    <div style="font-size:0.7rem; color:#64748b; margin-bottom:10px;">v1.0.0 | REV 8 (LEGACY MODE)</div>

    <div class="config-row">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Remind Every:</span>
            <span><input type="number" id="remind-min" class="input-mini" value="2"> mins</span>
        </div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <button onclick="initNotifications()" style="flex:1; padding:8px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">1. Enable</button>
            <button onclick="sendLegacyTest()" style="flex:1; padding:8px; background:#000; color:white; border:none; border-radius:5px; font-weight:bold;">2. Force Test</button>
        </div>
    </div>

    <button onclick="doTap('Test Symptom')" style="width:100%; max-width:320px; padding:12px; background:#64748b; color:white; border:none; border-radius:8px; font-weight:bold; margin-bottom:15px;">+ Log Test Symptom</button>

    <div id="list-active" style="width:100%; max-width:320px;"></div>
    <div id="status-log">LOG: Waiting for Enable...</div>

    <script>
        const KEY = 'symp_v100_final';
        let data = JSON.parse(localStorage.getItem(KEY)) || [];

        function logToBox(msg) {
            const box = document.getElementById('status-log');
            box.innerHTML += `<br>[${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'})}] ${msg}`;
            box.scrollTop = box.scrollHeight;
        }

        function initNotifications() {
            Notification.requestPermission().then(perm => {
                logToBox("Permission: " + perm);
                if(perm === 'granted') {
                    // Just a simple native notification - the "Old Way"
                    new Notification("Notifications Enabled!");
                }
            });
        }

        function sendLegacyTest() {
            logToBox("Sending Simple Notification...");
            // No tags, no renotify, no extra bloat.
            new Notification("Test Working!");
        }

        function doTap(name) {
            data.unshift({ 
                id: Date.now(), part: name, start: Date.now(), lastReminded: Date.now(), end: null 
            });
            save(); render();
        }

        function checkLogic() {
            const interval = parseInt(document.getElementById('remind-min').value) * 60000;
            const now = Date.now();
            let count = 0;

            data.forEach(s => {
                if (!s.end) {
                    const elapsed = now - (s.lastReminded || s.start);
                    if (elapsed >= interval) {
                        s.lastReminded = now;
                        count++;
                    }
                }
            });

            if (count > 0) {
                save();
                logToBox(`Fired for ${count} items.`);
                new Notification("Symptom Check-in", { body: `Update your ${count} active symptoms.` });
            }
            render();
        }

        function render() {
            const activeDiv = document.getElementById('list-active');
            const actives = data.filter(x => !x.end);
            const interval = parseInt(document.getElementById('remind-min').value) * 60000;
            const now = Date.now();

            activeDiv.innerHTML = actives.map(x => {
                const nextInMs = interval - (now - (x.lastReminded || x.start));
                const nextInMin = Math.max(0, Math.ceil(nextInMs / 60000));
                return `
                <div class="log-card">
                    <strong>${x.part}</strong>
                    <span class="debug-timer">Next Notification: ${nextInMin}m</span>
                    <button onclick="endLog(${x.id})" style="width:100%; margin-top:8px; background:black; color:white; border:none; padding:5px; border-radius:4px;">End</button>
                </div>`;
            }).join('');
        }

        function endLog(id) {
            const item = data.find(x => x.id === id);
            if(item) { item.end = Date.now(); save(); render(); }
        }

        function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

        // Run logic every 30 seconds
        setInterval(checkLogic, 30000);
        render();
    </script>
</body>
</html>
