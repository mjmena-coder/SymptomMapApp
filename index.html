<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Symptom Mapper v1.0.0</title>
    <style>
        :root { --bg: #f1f5f9; --primary: #2563eb; --text: #0f172a; --stroke: #1e293b; --card: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .header { text-align: center; margin-bottom: 15px; }
        .version-tag { font-size: 0.75rem; font-weight: 800; color: #64748b; letter-spacing: 1.5px; text-transform: uppercase; }

        .test-row { display: flex; gap: 8px; width: 100%; max-width: 340px; margin-bottom: 12px; }
        .test-btn { flex: 1; font-size: 11px; padding: 8px; background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; width: 100%; }
        button { padding: 12px 16px; border-radius: 10px; border: none; background: #475569; color: white; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        button.active { background: var(--primary); transform: scale(1.05); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        .body-canvas { width: 100%; max-width: 340px; background: var(--card); border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #e2e8f0; box-sizing: border-box;}
        svg { width: 100%; height: auto; display: block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05)); }
        
        .body-part { stroke: var(--stroke); stroke-width: 1.2; transition: fill 0.3s ease; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        
        @keyframes sync-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .heat-mode-on .body-part { fill: #f8fafc !important; stroke: #cbd5e1; }
        .heat-mode-on .heat-low { fill: #fbbf24 !important; animation: sync-pulse 2s infinite; }
        .heat-mode-on .heat-med { fill: #f97316 !important; animation: sync-pulse 2s infinite; }
        .heat-mode-on .heat-high { fill: #dc2626 !important; animation: sync-pulse 2s infinite; }

        #view-back { display: none; }
        .showing-back #view-front { display: none; }
        .showing-back #view-back { display: block; }

        .section-title { width: 100%; max-width: 340px; font-size: 0.9rem; font-weight: 700; color: #64748b; margin: 15px 0 8px 5px; }
        .log-card { position: relative; background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 12px; border-left: 6px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.04); width: 100%; max-width: 340px; box-sizing: border-box; }
        .active-card { border-left-color: #f59e0b; background: #fffbeb; border-style: solid; }
        .note-text { font-size: 0.85rem; color: #64748b; margin-top: 6px; padding: 6px; background: #f8fafc; border-radius: 6px; border: 1px dashed #e2e8f0; }
        
        .del-btn { position: absolute; top: 12px; right: 12px; background: #fee2e2; color: #b91c1c; font-size: 11px; padding: 5px 10px; border-radius: 6px; border: none; font-weight: bold; }
        .edit-btn { background: #e0f2fe; color: #0369a1; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; font-weight: bold; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 88%; padding: 28px; border-radius: 24px; text-align: center; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        input, textarea { width: 100%; padding: 12px; margin: 12px 0; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0; font-size: 1.6rem; color: var(--primary);">Symptom Mapper</h2>
        <div class="version-tag">Release v1.0.0 | Rev. 0</div>
    </div>

    <div class="test-row">
        <button class="test-btn" onclick="requestPermission()">Enable Push</button>
        <button class="test-btn" onclick="sendTestNotify()">Check Sync</button>
    </div>

    <div class="controls">
        <button id="btn-mode" onclick="toggleMode()">Mode: Log</button>
        <button onclick="toggleView()" style="background:#7c3aed">Flip View</button>
        <button onclick="exportCSV()" style="background:#059669">Export Data</button>
        <button onclick="resetData()" style="background:#ef4444">Reset</button>
    </div>

    <div class="body-canvas" id="canvas-container">
        <svg viewBox="0 0 200 400"><g id="view-front">
            <path id="head-left" class="body-part" fill="#f5f3ff" d="M100,20 Q70,20 70,50 L100,50 Z" onclick="doTap('Head Left')" />
            <rect id="head-center" class="body-part" fill="#ede9fe" x="90" y="20" width="20" height="30" onclick="doTap('Head Center')" />
            <path id="head-right" class="body-part" fill="#f5f3ff" d="M100,20 Q130,20 130,50 L100,50 Z" onclick="doTap('Head Right')" />
            <rect id="neck-throat" class="body-part" fill="#f0f9ff" x="85" y="55" width="30" height="15" rx="2" onclick="doTap('Neck / Throat')" />
            <rect id="chest-left" class="body-part" fill="#eff6ff" x="50" y="75" width="40" height="70" rx="5" onclick="doTap('Chest Left')" />
            <rect id="chest-center" class="body-part" fill="#dbeafe" x="90" y="75" width="20" height="70" onclick="doTap('Chest Center')" />
            <rect id="chest-right" class="body-part" fill="#eff6ff" x="110" y="75" width="40" height="70" rx="5" onclick="doTap('Chest Right')" />
            <rect id="abdomen-left" class="body-part" fill="#f0fdfa" x="55" y="145" width="35" height="50" onclick="doTap('Abdomen Left')" />
            <rect id="abdomen-center" class="body-part" fill="#ccfbf1" x="90" y="145" width="20" height="50" onclick="doTap('Abdomen Center')" />
            <rect id="abdomen-right" class="body-part" fill="#f0fdfa" x="110" y="145" width="35" height="50" onclick="doTap('Abdomen Right')" />
            <rect id="groin-left" class="body-part" fill="#fffbeb" x="65" y="195" width="25" height="35" onclick="doTap('Groin Left')" />
            <rect id="groin-center" class="body-part" fill="#fef3c7" x="90" y="195" width="20" height="35" onclick="doTap('Groin Center')" />
            <rect id="groin-right" class="body-part" fill="#fffbeb" x="110" y="195" width="25" height="35" onclick="doTap('Groin Right')" />
            <path id="left-arm" class="body-part" fill="#f8fafc" d="M50,80 Q20,80 20,110 L35,210 Q45,220 55,210 Z" onclick="doTap('Left Arm')" />
            <path id="right-arm" class="body-part" fill="#f8fafc" d="M150,80 Q180,80 180,110 L165,210 Q155,220 145,210 Z" onclick="doTap('Right Arm')" />
            <path id="left-leg" class="body-part" fill="#f8fafc" d="M65,230 L90,230 L90,360 Q75,375 60,360 Z" onclick="doTap('Left Leg')" />
            <path id="right-leg" class="body-part" fill="#f8fafc" d="M110,230 L135,230 L135,360 Q120,375 105,360 Z" onclick="doTap('Right Leg')" />
        </g>
        <g id="view-back">
            <rect id="spine" class="body-part" fill="#f1f5f9" x="88" y="70" width="24" height="160" onclick="doTap('Spine')" />
            <rect id="back-left-top" class="body-part" fill="#f8fafc" x="45" y="70" width="43" height="50" onclick="doTap('Back Left Top')" />
            <rect id="back-right-top" class="body-part" fill="#f8fafc" x="112" y="70" width="43" height="50" onclick="doTap('Back Right Top')" />
            <rect id="back-left-mid" class="body-part" fill="#f8fafc" x="48" y="120" width="40" height="50" onclick="doTap('Back Left Mid')" />
            <rect id="back-right-mid" class="body-part" fill="#f8fafc" x="112" y="120" width="40" height="50" onclick="doTap('Back Right Mid')" />
            <rect id="back-left-low" class="body-part" fill="#f8fafc" x="50" y="170" width="38" height="60" onclick="doTap('Back Left Low')" />
            <rect id="back-right-low" class="body-part" fill="#f8fafc" x="112" y="170" width="38" height="60" onclick="doTap('Back Right Low')" />
            <rect id="left-glute" class="body-part" fill="#f1f5f9" x="50" y="230" width="45" height="55" rx="15" onclick="doTap('Left Glute')" />
            <rect id="right-glute" class="body-part" fill="#f1f5f9" x="105" y="230" width="45" height="55" rx="15" onclick="doTap('Right Glute')" />
        </g></svg>
    </div>

    <div id="list-active"></div>
    <div id="list-history"></div>

    <div id="pop" class="modal">
        <div class="modal-content">
            <h3 id="pop-title" style="margin-top:0; color:var(--primary)">Log Symptom</h3>
            
            <p style="margin: 5px 0; font-size: 0.9rem;">Intensity: <span id="int-val" style="font-weight:bold; color:var(--primary)">5</span>/10</p>
            <input type="range" id="int-slide" min="1" max="10" value="5" oninput="document.getElementById('int-val').innerText=this.value">
            
            <p style="margin: 10px 0 0 0; font-size: 0.9rem; font-weight: bold; text-align: left;">Notes</p>
            <textarea id="pop-notes" rows="3" placeholder="Describe the feeling..."></textarea>
            
            <div id="time-edit-box">
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; font-weight: bold; text-align: left;">Backdate (Minutes ago)</p>
                <input type="number" id="pop-backdate" value="0" min="0">
            </div>

            <button id="pop-confirm" style="background:var(--primary); width:100%; margin-top:15px; padding:15px; font-weight:bold; color:white; border-radius:12px; border:none;" onclick="confirmLog()">Confirm Entry</button>
            <button onclick="closePop()" style="width:100%; margin-top:10px; background:#f1f5f9; color:#64748b; padding:12px; border-radius:12px; border:none; font-weight:bold;">Cancel</button>
        </div>
    </div>

    <script>
        const KEY = 'symptom_mapper_v1_0_0';
        let mode = 'log'; let view = 'front'; let editingId = null; let activePart = '';
        let data = JSON.parse(localStorage.getItem(KEY)) || [];

        // SERVICE WORKER & REMINDERS
        if ('serviceWorker' in navigator) {
            const swCode = `self.addEventListener('notificationclick', e => e.notification.close());`;
            const blob = new Blob([swCode], {type: 'text/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        function checkReminders() {
            if (Notification.permission !== "granted") return;
            const hourMs = 3600000;
            const now = Date.now();
            let symptomsToAlert = data.filter(s => !s.end && (now - s.start) >= hourMs && !s.reminded);
            
            if (symptomsToAlert.length > 0) {
                symptomsToAlert.forEach(s => s.reminded = true);
                save();
                new Notification("Ongoing Symptom Reminder", {
                    body: `You have ${symptomsToAlert.length} active symptoms for over 1 hour. Tap to update.`,
                    tag: 'symptom-alert'
                });
            }
        }

        function requestPermission() { Notification.requestPermission(); }
        function sendTestNotify() { checkReminders(); alert("Reminder Sync Complete."); }

        function doTap(name) {
            if (mode === 'heat') return;
            editingId = null;
            activePart = name;
            document.getElementById('pop-title').innerText = name;
            document.getElementById('pop-notes').value = '';
            document.getElementById('pop-backdate').value = 0;
            document.getElementById('time-edit-box').style.display = 'block';
            document.getElementById('pop').style.display = 'flex';
        }

        function editItem(id) {
            const item = data.find(x => x.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('pop-title').innerText = "Edit " + item.part;
            document.getElementById('int-slide').value = item.val;
            document.getElementById('int-val').innerText = item.val;
            document.getElementById('pop-notes').value = item.notes || '';
            document.getElementById('time-edit-box').style.display = 'none';
            document.getElementById('pop').style.display = 'flex';
        }

        function confirmLog() {
            const val = parseInt(document.getElementById('int-slide').value);
            const notes = document.getElementById('pop-notes').value;
            const backdate = parseInt(document.getElementById('pop-backdate').value) || 0;

            if (editingId) {
                const item = data.find(x => x.id === editingId);
                item.val = val;
                item.notes = notes;
            } else {
                data.unshift({ 
                    id: Date.now(), 
                    part: activePart, 
                    val: val, 
                    start: Date.now() - (backdate * 60000), 
                    end: null, 
                    notes: notes,
                    reminded: false
                });
            }
            save(); closePop(); render();
        }

        function closePop() { document.getElementById('pop').style.display = 'none'; }
        function endLog(id) { const item = data.find(x => x.id === id); if(item) { item.end = Date.now(); save(); render(); } }
        function deleteItem(id) { if(confirm("Permanently delete?")) { data = data.filter(x => x.id !== id); save(); render(); } }

        function toggleMode() {
            mode = (mode === 'log') ? 'heat' : 'log';
            document.getElementById('btn-mode').innerText = `Mode: ${mode.toUpperCase()}`;
            document.getElementById('btn-mode').classList.toggle('active', mode === 'heat');
            document.getElementById('canvas-container').classList.toggle('heat-mode-on', mode === 'heat');
            render();
        }

        function toggleView() {
            view = (view === 'front') ? 'back' : 'front';
            document.getElementById('canvas-container').classList.toggle('showing-back');
            render();
        }

        function getDurationText(start, end) {
            const totalMs = (end || Date.now()) - start;
            const totalMinutes = Math.max(1, Math.ceil(totalMs / 60000));
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        function render() {
            const activeDiv = document.getElementById('list-active');
            const historyDiv = document.getElementById('list-history');
            const actives = data.filter(x => !x.end);
            const pasts = data.filter(x => x.end);

            activeDiv.innerHTML = actives.length ? `<div class="section-title">ACTIVE TRACKING</div>` + actives.map(x => `
                <div class="log-card active-card">
                    <strong>${x.part}</strong> <span style="float:right">${x.val}/10</span><br>
                    <small>Started: ${getDurationText(x.start)} ago</small>
                    ${x.notes ? `<div class="note-text">${x.notes}</div>` : ''}
                    <div style="margin-top:12px; display:flex; gap:8px;">
                        <button onclick="endLog(${x.id})" style="background:#0f172a; color:white; padding:8px 12px; flex:2;">End Symptom</button>
                        <button class="edit-btn" style="margin:0" onclick="editItem(${x.id})">Edit</button>
                    </div>
                    <button class="del-btn" onclick="deleteItem(${x.id})">×</button>
                </div>
            `).join('') : "";

            historyDiv.innerHTML = pasts.length ? `<div class="section-title">RECENT HISTORY</div>` + pasts.slice(0,8).map(x => `
                <div class="log-card">
                    <strong>${x.part}</strong> <span style="float:right">${x.val}/10</span><br>
                    <small>Duration: ${getDurationText(x.start, x.end)}</small>
                    ${x.notes ? `<div class="note-text">${x.notes}</div>` : ''}
                    <button class="del-btn" onclick="deleteItem(${x.id})">×</button>
                </div>
            `).join('') : "";

            applyHeat();
        }

        function applyHeat() {
            document.querySelectorAll('.body-part').forEach(el => el.classList.remove('heat-low', 'heat-med', 'heat-high'));
            if(mode !== 'heat') return;
            const scores = {};
            data.forEach(x => {
                const id = x.part.toLowerCase().replace(/ \/ /g, '-').replace(/ /g, '-');
                if(!scores[id]) scores[id] = [];
                scores[id].push(x.val);
            });
            for(let id in scores) {
                const avg = scores[id].reduce((a,b) => a+b, 0) / scores[id].length;
                const el = document.getElementById(id);
                if(el) {
                    if(avg >= 7) el.classList.add('heat-high');
                    else if(avg >= 4) el.classList.add('heat-med');
                    else el.classList.add('heat-low');
                }
            }
        }

        function save() { localStorage.setItem(KEY, JSON.stringify(data)); }
        function resetData() { if(confirm("Wipe all data?")) { data = []; save(); render(); } }
        function exportCSV() {
            let csv = "Part,Intensity,Notes,Start,End,Duration\n";
            data.forEach(x => csv += `"${x.part}",${x.val},"${x.notes || ''}","${new Date(x.start).toLocaleString()}","${x.end ? new Date(x.end).toLocaleString() : 'Active'}","${getDurationText(x.start, x.end)}"\n`);
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='symptom_data.csv'; a.click();
        }

        setInterval(() => { render(); checkReminders(); }, 60000);
        render();
    </script>
</body>
</html>
