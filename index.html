<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Symptom Mapper Pro</title>
    <style>
        :root { --bg: #f8fafc; --primary: #2563eb; --secondary: #64748b; --text: #0f172a; --border: #cbd5e1; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        .header { text-align: center; width: 100%; margin-bottom: 5px; }
        .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px; }
        
        button { padding: 12px 15px; border-radius: 8px; border: none; background: var(--secondary); color: white; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button.active { background: var(--primary); }
        button.flip { background: #7c3aed; }
        button.export { background: #1e293b; }

        /* SVG Canvas */
        .body-canvas { width: 340px; height: 550px; background: white; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 10px; position: relative; touch-action: manipulation; }
        .body-part { fill: #f1f5f9; stroke: #94a3b8; stroke-width: 1; transition: 0.2s; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .body-part:active { fill: #cbd5e1 !important; }
        
        /* View Toggling */
        #view-back { display: none; }
        .showing-back #view-front { display: none; }
        .showing-back #view-back { display: block; }

        /* Modal Styles */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        input[type="range"] { width: 100%; margin: 20px 0; height: 10px; border-radius: 5px; background: #e2e8f0; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; border-radius: 50%; background: var(--primary); cursor: pointer; }

        /* Heatmap Colors 1-10 */
        .heat-1 { fill: #fef08a !important; } .heat-2 { fill: #fde047 !important; }
        .heat-3 { fill: #facc15 !important; } .heat-4 { fill: #fbbf24 !important; }
        .heat-5 { fill: #f59e0b !important; } .heat-6 { fill: #ea580c !important; }
        .heat-7 { fill: #dc2626 !important; } .heat-8 { fill: #b91c1c !important; }
        .heat-9 { fill: #991b1b !important; } .heat-10 { fill: #450a0a !important; }
        
        .log-card { background: white; padding: 12px; margin-top: 8px; border-radius: 10px; border-left: 4px solid var(--primary); font-size: 13px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 100%; max-width: 340px; }
    </style>
</head>
<body>

<div class="header">
    <h2>Symptom Mapper</h2>
    <p id="status-text" style="margin: 5px 0; font-size: 0.9em; color: var(--secondary);">
        Mode: <strong>Log (Front)</strong>
    </p>
    <div style="font-size: 0.65em; color: #94a3b8; margin-top: -5px; letter-spacing: 0.5px;">
        v0.1-Initial | BRANCH: MAIN
    </div>
</div>

    <div class="controls">
        <button id="mode-btn" class="active" onclick="toggleMode()">Mode: Log</button>
        <button class="flip" onclick="toggleView()">Flip Body</button>
        <button class="export" onclick="exportData()">CSV Export</button>
    </div>

    <div class="body-canvas" id="canvas-container">
        <svg viewBox="0 0 200 550" xmlns="http://www.w3.org/2000/svg">
            <g id="view-front">
                <path id="head-left" class="body-part" d="M 100 20 A 25 25 0 0 0 75 45 L 100 45 Z" onclick="handlePartClick('Head Left')" />
                <rect id="head-center" class="body-part" x="95" y="20" width="10" height="50" onclick="handlePartClick('Head Center')" />
                <path id="head-right" class="body-part" d="M 100 20 A 25 25 0 0 1 125 45 L 100 45 Z" onclick="handlePartClick('Head Right')" />
                
                <rect id="chest-left" class="body-part" x="60" y="85" width="25" height="70" rx="2" onclick="handlePartClick('Chest Left')" />
                <rect id="chest-center" class="body-part" x="85" y="85" width="30" height="70" onclick="handlePartClick('Chest Center')" />
                <rect id="chest-right" class="body-part" x="115" y="85" width="25" height="70" rx="2" onclick="handlePartClick('Chest Right')" />

                <rect id="abdomen-left" class="body-part" x="65" y="160" width="22" height="60" onclick="handlePartClick('Abdomen Left')" />
                <rect id="abdomen-center" class="body-part" x="87" y="160" width="26" height="60" onclick="handlePartClick('Abdomen Center')" />
                <rect id="abdomen-right" class="body-part" x="113" y="160" width="22" height="60" onclick="handlePartClick('Abdomen Right')" />

                <rect id="groin-left" class="body-part" x="70" y="225" width="20" height="35" onclick="handlePartClick('Groin Left')" />
                <rect id="groin-center" class="body-part" x="90" y="225" width="20" height="35" onclick="handlePartClick('Groin Center')" />
                <rect id="groin-right" class="body-part" x="110" y="225" width="20" height="35" onclick="handlePartClick('Groin Right')" />

                <rect id="left-arm" class="body-part" x="20" y="90" width="30" height="130" rx="15" onclick="handlePartClick('Left Arm')" />
                <rect id="right-arm" class="body-part" x="150" y="90" width="30" height="130" rx="15" onclick="handlePartClick('Right Arm')" />
                <path id="left-leg" class="body-part" d="M 70 265 L 55 480 L 95 480 L 95 265 Z" onclick="handlePartClick('Left Leg')" />
                <path id="right-leg" class="body-part" d="M 130 265 L 145 480 L 105 480 L 105 265 Z" onclick="handlePartClick('Right Leg')" />
            </g>

            <g id="view-back">
                <rect id="spine" class="body-part" x="96" y="80" width="8" height="160" onclick="handlePartClick('Spine')" />

                <rect id="back-left-top" class="body-part" x="60" y="80" width="36" height="50" onclick="handlePartClick('Back Left Top')" />
                <rect id="back-right-top" class="body-part" x="104" y="80" width="36" height="50" onclick="handlePartClick('Back Right Top')" />
                
                <rect id="back-left-mid" class="body-part" x="65" y="135" width="31" height="50" onclick="handlePartClick('Back Left Mid')" />
                <rect id="back-right-mid" class="body-part" x="104" y="135" width="31" height="50" onclick="handlePartClick('Back Right Mid')" />

                <rect id="back-left-low" class="body-part" x="65" y="190" width="31" height="45" onclick="handlePartClick('Back Left Low')" />
                <rect id="back-right-low" class="body-part" x="104" y="190" width="31" height="45" onclick="handlePartClick('Back Right Low')" />

                <rect id="left-glute" class="body-part" x="60" y="240" width="38" height="50" rx="10" onclick="handlePartClick('Left Glute')" />
                <rect id="right-glute" class="body-part" x="102" y="240" width="38" height="50" rx="10" onclick="handlePartClick('Right Glute')" />
            </g>
        </svg>
    </div>

    <div id="log-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0;">Logging...</h3>
            <div id="history-section" style="display:none; margin-bottom:15px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px;"></div>
            <div id="form-section">
                <p>Intensity: <span id="int-label" style="font-weight:bold; color:var(--primary); font-size: 1.2em;">5</span>/10</p>
                <input type="range" id="intensity-input" min="1" max="10" value="5" oninput="document.getElementById('int-label').innerText=this.value">
                <button class="active" onclick="saveEntry()" style="width:100%">Save Start Time</button>
            </div>
            <button onclick="closeModal()" style="width:100%; margin-top:12px; background:#e2e8f0; color:#475569;">Close</button>
        </div>
    </div>

    <div id="log-display"></div>

    <script>
        // Check if JS is even loading
        console.log("Symptom Mapper script initialized.");

        let currentMode = 'log'; 
        let currentView = 'front'; 
        let currentSelectedPart = '';
        let appLogs = JSON.parse(localStorage.getItem('userSymptomData')) || [];

        function toggleMode() {
            currentMode = (currentMode === 'log') ? 'heat' : 'log';
            const btn = document.getElementById('mode-btn');
            btn.innerText = `Mode: ${currentMode.toUpperCase()}`;
            btn.classList.toggle('active');
            updateUIStatus();
            if (currentMode === 'heat') applyHeatMapColors(); else clearHeatMapColors();
        }

        function toggleView() {
            currentView = (currentView === 'front') ? 'back' : 'front';
            document.getElementById('canvas-container').classList.toggle('showing-back');
            updateUIStatus();
            if (currentMode === 'heat') applyHeatMapColors();
        }

        function updateUIStatus() {
            document.getElementById('status-text').innerHTML = `Mode: <strong>${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} (${currentView.toUpperCase()})</strong>`;
        }

        // THIS IS THE MAIN INTERACTION FUNCTION
        function handlePartClick(partName) {
            console.log("Clicked:", partName);
            currentSelectedPart = partName;
            
            // UI elements
            const modal = document.getElementById('log-modal');
            const title = document.getElementById('modal-title');
            const history = document.getElementById('history-section');
            const form = document.getElementById('form-section');

            title.innerText = partName;
            modal.style.display = 'flex'; // This triggers the popup
            
            if (currentMode === 'heat') {
                form.style.display = 'none';
                history.style.display = 'block';
                const relatedLogs = appLogs.filter(l => l.part === partName);
                history.innerHTML = relatedLogs.length ? 
                    relatedLogs.map(l => `<div style='padding:5px; border-bottom:1px solid #eee; font-size:12px;'>${l.date}: ${l.intensity}/10</div>`).join('') : 
                    "<p style='font-size:12px; color:gray;'>No history for this part.</p>";
            } else {
                form.style.display = 'block';
                history.style.display = 'none';
            }
        }

        function saveEntry() {
            const newLog = {
                part: currentSelectedPart,
                intensity: parseInt(document.getElementById('intensity-input').value),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                view: currentView,
                timestamp: Date.now()
            };
            appLogs.unshift(newLog);
            localStorage.setItem('userSymptomData', JSON.stringify(appLogs));
            closeModal();
            updateRecentLogsList();
            alert("Symptom logged. Stay tuned for your follow-up!");
        }

        function applyHeatMapColors() {
            clearHeatMapColors();
            const partStats = {};
            appLogs.forEach(log => {
                if(!partStats[log.part]) partStats[log.part] = {sum:0, count:0};
                partStats[log.part].sum += log.intensity;
                partStats[log.part].count++;
            });

            for(let name in partStats) {
                const average = Math.round(partStats[name].sum / partStats[name].count);
                const svgId = name.toLowerCase().replace(/ /g, '-');
                const element = document.getElementById(svgId);
                if(element) {
                    element.classList.add(`heat-${average > 10 ? 10 : average}`);
                }
            }
        }

        function clearHeatMapColors() {
            document.querySelectorAll('.body-part').forEach(el => {
                const classes = Array.from(el.classList);
                classes.forEach(c => { if(c.startsWith('heat-')) el.classList.remove(c); });
            });
        }

        function exportData() {
            if(appLogs.length === 0) { alert("No data to export!"); return; }
            let csvData = "Date,Time,Body Part,Intensity,View\n";
            appLogs.forEach(l => { csvData += `${l.date},${l.time},"${l.part}",${l.intensity},${l.view}\n`; });
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `SymptomLog_${new Date().toLocaleDateString()}.csv`; a.click();
        }

        function closeModal() { document.getElementById('log-modal').style.display = 'none'; }
        
        function updateRecentLogsList() {
            const listDiv = document.getElementById('log-display');
            listDiv.innerHTML = appLogs.slice(0,3).map(l => `<div class='log-card'><b>${l.part}</b>: ${l.intensity}/10 <br><small>${l.date} at ${l.time}</small></div>`).join('');
        }

        updateRecentLogsList();
    </script>
</body>
</html>
