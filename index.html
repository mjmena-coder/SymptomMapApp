<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Symptom Mapper v0.3.2</title>
    <style>
        :root { --bg: #f1f5f9; --primary: #2563eb; --text: #0f172a; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        button { padding: 12px; border-radius: 8px; border: none; background: #64748b; color: white; font-weight: bold; cursor: pointer; }
        button.active { background: var(--primary); }

        .body-canvas { width: 100%; max-width: 320px; background: white; border-radius: 15px; padding: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        svg { width: 100%; height: auto; display: block; }
        
        /* Ensure parts are easy to tap */
        .body-part { fill: #e2e8f0; stroke: #475569; stroke-width: 1.5; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .body-part:active { fill: #94a3b8 !important; }
        
        #view-back { display: none; }
        .showing-back #view-front { display: none; }
        .showing-back #view-back { display: block; }

        .log-card { background: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 5px solid var(--primary); width: 100%; max-width: 320px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .active-card { background: #fffbeb; border: 2px solid #f59e0b; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 80%; padding: 25px; border-radius: 15px; text-align: center; }
        
        /* Heatmap classes */
        .heat-1 { fill: #fef08a !important; } .heat-5 { fill: #f97316 !important; } .heat-10 { fill: #b91c1c !important; }
    </style>
</head>
<body>

    <div style="text-align:center; margin-bottom:10px;">
        <h2 style="margin:0">Symptom Mapper</h2>
        <small style="color: #64748b;">v0.3.2 | Branch: Main (Fixed Taps)</small>
    </div>

    <div class="controls">
        <button id="btn-mode" class="active" onclick="toggleMode()">Log Mode</button>
        <button onclick="toggleView()" style="background:#7c3aed">Flip Body</button>
        <button onclick="exportCSV()">Export</button>
        <button onclick="resetData()" style="background:#ef4444">Reset</button>
    </div>

    <div class="body-canvas" id="canvas-container">
        <svg viewBox="0 0 200 500">
            <g id="view-front">
                <path id="head-left" class="body-part" d="M100,20 Q70,20 70,50 L100,50 Z" onclick="doTap('Head Left')" />
                <rect id="head-center" class="body-part" x="90" y="20" width="20" height="40" onclick="doTap('Head Center')" />
                <path id="head-right" class="body-part" d="M100,20 Q130,20 130,50 L100,50 Z" onclick="doTap('Head Right')" />

                <rect id="chest-left" class="body-part" x="60" y="80" width="35" height="60" onclick="doTap('Chest Left')" />
                <rect id="chest-center" class="body-part" x="95" y="80" width="10" height="60" onclick="doTap('Chest Center')" />
                <rect id="chest-right" class="body-part" x="105" y="80" width="35" height="60" onclick="doTap('Chest Right')" />

                <rect id="abdomen-left" class="body-part" x="60" y="150" width="35" height="60" onclick="doTap('Abdomen Left')" />
                <rect id="abdomen-center" class="body-part" x="95" y="150" width="10" height="60" onclick="doTap('Abdomen Center')" />
                <rect id="abdomen-right" class="body-part" x="105" y="150" width="35" height="60" onclick="doTap('Abdomen Right')" />
            </g>
            <g id="view-back">
                <rect id="spine" class="body-part" x="95" y="80" width="10" height="150" onclick="doTap('Spine')" />
                <rect id="back-left-low" class="body-part" x="60" y="160" width="35" height="60" onclick="doTap('Back Left Low')" />
                <rect id="back-right-low" class="body-part" x="105" y="160" width="35" height="60" onclick="doTap('Back Right Low')" />
            </g>
        </svg>
    </div>

    <div id="list-active" style="width:100%; max-width:320px;"></div>
    <div id="list-history" style="width:100%; max-width:320px; margin-top:20px;"></div>

    <div id="pop" class="modal">
        <div class="modal-content">
            <h3 id="pop-title">Part</h3>
            <p>Intensity: <span id="int-val">5</span>/10</p>
            <input type="range" id="int-slide" min="1" max="10" value="5" style="width:100%" oninput="document.getElementById('int-val').innerText=this.value">
            <button class="active" onclick="confirmLog()" style="width:100%; margin-top:15px;">Start Tracking</button>
            <button onclick="closePop()" style="width:100%; margin-top:10px; background:#ccc;">Cancel</button>
        </div>
    </div>

    <script>
        let mode = 'log'; let view = 'front'; let activePart = '';
        let data = JSON.parse(localStorage.getItem('symp_v3_2')) || [];

        function doTap(name) {
            activePart = name;
            document.getElementById('pop-title').innerText = name;
            document.getElementById('pop').style.display = 'flex';
        }

        function closePop() { document.getElementById('pop').style.display = 'none'; }

        function confirmLog() {
            const entry = {
                id: Date.now(),
                part: activePart,
                val: parseInt(document.getElementById('int-slide').value),
                start: new Date().toLocaleString(),
                end: null
            };
            data.unshift(entry);
            saveAndRefresh();
            closePop();
        }

        function endLog(id) {
            const item = data.find(x => x.id === id);
            if(item) {
                item.end = new Date().toLocaleString();
                saveAndRefresh();
            }
        }

        function toggleMode() {
            mode = (mode === 'log') ? 'heat' : 'log';
            document.getElementById('btn-mode').innerText = mode === 'log' ? "Log Mode" : "Heat Map";
            saveAndRefresh();
        }

        function toggleView() {
            view = (view === 'front') ? 'back' : 'front';
            document.getElementById('canvas-container').classList.toggle('showing-back');
            saveAndRefresh();
        }

        function saveAndRefresh() {
            localStorage.setItem('symp_v3_2', JSON.stringify(data));
            renderLists();
            if(mode === 'heat') applyHeat(); else clearHeat();
        }

        function renderLists() {
            const activeDiv = document.getElementById('list-active');
            const historyDiv = document.getElementById('list-history');
            
            const actives = data.filter(x => !x.end);
            const pasts = data.filter(x => x.end);

            activeDiv.innerHTML = actives.length ? "<b>Active</b>" + actives.map(x => `
                <div class="log-card active-card">
                    <strong>${x.part}</strong> (${x.val}/10)<br><small>${x.start}</small><br>
                    <button onclick="endLog(${x.id})" style="background:#000; width:100%; margin-top:5px; padding:5px;">End Now</button>
                </div>
            `).join('') : "";

            historyDiv.innerHTML = pasts.length ? "<b>History</b>" + pasts.slice(0,5).map(x => `
                <div class="log-card">
                    <strong>${x.part}</strong> (${x.val}/10)<br><small>${x.start} - ${x.end.split(',')[1]}</small>
                </div>
            `).join('') : "";
        }

        function applyHeat() {
            clearHeat();
            const scores = {};
            data.forEach(x => {
                if(!scores[x.part]) scores[x.part] = {s:0, c:0};
                scores[x.part].s += x.val; scores[x.part].c++;
            });
            for(let p in scores) {
                const avg = Math.round(scores[p].s / scores[p].c);
                const el = document.getElementById(p.toLowerCase().replace(/ /g, '-'));
                if(el) el.classList.add('heat-' + (avg > 10 ? 10 : avg));
            }
        }

        function clearHeat() {
            document.querySelectorAll('.body-part').forEach(el => {
                el.classList.remove(...Array.from(el.classList).filter(c => c.startsWith('heat-')));
            });
        }

        function resetData() { if(confirm("Clear all?")) { data = []; saveAndRefresh(); } }

        function exportCSV() {
            let csv = "Part,Level,Start,End\n";
            data.forEach(x => csv += `"${x.part}",${x.val},"${x.start}","${x.end || 'Active'}"\n`);
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='logs.csv'; a.click();
        }

        renderLists();
    </script>
</body>
</html>
