<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Symptom Mapper v1.2.0</title>
    <style>
        :root { --bg: #f8fafc; --primary: #2563eb; --text: #0f172a; --stroke: #334155; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .header { text-align: center; margin-bottom: 10px; }
        .version-tag { font-size: 0.7rem; font-weight: bold; color: #64748b; letter-spacing: 1px; }

        .config-row { width: 100%; max-width: 320px; background: white; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; box-sizing: border-box;}
        .input-mini { width: 50px; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: bold; }

        .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; width: 100%; }
        button { padding: 10px 14px; border-radius: 8px; border: none; background: #64748b; color: white; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; }
        button.active { background: var(--primary); transform: scale(1.05); }

        /* BODY MAP & HEAT LOGIC */
        .body-canvas { width: 100%; max-width: 320px; background: white; border-radius: 20px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; box-sizing: border-box;}
        svg { width: 100%; height: auto; display: block; }
        .body-part { stroke: var(--stroke); stroke-width: 1.2; transition: fill 0.3s ease; cursor: pointer; -webkit-tap-highlight-color: transparent; fill: #f8fafc; }
        
        #view-back { display: none; }
        .showing-back #view-front { display: none; }
        .showing-back #view-back { display: block; }

        @keyframes sync-pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .heat-mode-on .body-part { fill: #f1f5f9 !important; stroke: #cbd5e1; }
        .heat-mode-on .heat-low { fill: #fef08a !important; animation: sync-pulse 2s infinite ease-in-out; }
        .heat-mode-on .heat-med { fill: #f97316 !important; animation: sync-pulse 2s infinite ease-in-out; }
        .heat-mode-on .heat-high { fill: #b91c1c !important; animation: sync-pulse 2s infinite ease-in-out; }

        /* CARDS */
        .log-card { position: relative; background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.03); width: 100%; max-width: 320px; box-sizing: border-box; }
        .active-card { border-left-color: #f59e0b; background: #fffbeb; }
        .del-btn { position: absolute; top: 8px; right: 8px; background: #fee2e2; color: #b91c1c; font-size: 10px; padding: 4px 8px; border-radius: 4px; border: none; }

        /* MODAL & DRAWERS */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 85%; padding: 25px; border-radius: 20px; text-align: left; max-height: 90vh; overflow-y: auto; }
        .drawer { display: none; margin-top: 10px; padding: 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; }
        .descriptor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        textarea { width: 100%; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; box-sizing: border-box; font-family: inherit; margin-top: 5px;}
        
        .time-select-row { display: flex; align-items: center; gap: 5px; margin-top: 5px; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; background: white; font-size: 14px; }

        input[type="range"].rev-slider { width: 100%; appearance: none; height: 8px; border-radius: 5px; background: #e2e8f0; outline: none; margin: 15px 0; }
        input[type="range"].rev-slider::-webkit-slider-thumb { appearance: none; width: 22px; height: 22px; border-radius: 50%; background: var(--primary); border: 3px solid white; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        #status-log { width: 100%; max-width: 320px; height: 60px; font-size: 10px; font-family: monospace; background: #000; color: #0f0; padding: 8px; border-radius: 8px; overflow-y: auto; margin-top: 10px; box-sizing: border-box; }

        /* IMPORT MODAL */
        .import-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 20px 0; }
        .import-content { background: white; width: 90%; max-width: 420px; margin: auto; padding: 22px; border-radius: 20px; box-sizing: border-box; }
        .import-drop-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; background: #f8fafc; transition: 0.2s; margin-bottom: 16px; }
        .import-drop-zone.drag-over { border-color: var(--primary); background: #eff6ff; }
        .import-drop-zone input[type="file"] { display: none; }
        .import-step { display: none; }
        .import-step.active { display: block; }
        .import-status { font-size: 12px; color: #64748b; margin: 8px 0; min-height: 20px; font-family: monospace; }
        .import-status.error { color: #dc2626; }
        .import-status.success { color: #16a34a; }
        .preview-table { width: 100%; font-size: 11px; border-collapse: collapse; margin-top: 10px; max-height: 260px; overflow-y: auto; display: block; }
        .preview-table th { background: #f1f5f9; padding: 6px 8px; text-align: left; font-weight: 600; position: sticky; top: 0; }
        .preview-table td { padding: 5px 8px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .preview-table tr:hover td { background: #f8fafc; }
        .preview-row-skip td { opacity: 0.4; text-decoration: line-through; }
        .badge { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-ok { background: #dcfce7; color: #16a34a; }
        .badge-warn { background: #fef9c3; color: #ca8a04; }
        .badge-err { background: #fee2e2; color: #dc2626; }
        .merge-option { display: flex; gap: 8px; margin: 12px 0; }
        .merge-option label { flex: 1; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; cursor: pointer; text-align: center; font-size: 12px; transition: 0.2s; }
        .merge-option input[type="radio"] { display: none; }
        .merge-option input[type="radio"]:checked + label { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: bold; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #cbd5e1; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-primary { background: var(--primary); color: white; border: none; border-radius: 8px; padding: 11px; font-weight: bold; cursor: pointer; width: 100%; font-size: 14px; }
        .btn-secondary { background: #e2e8f0; color: #475569; border: none; border-radius: 8px; padding: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 13px; margin-top: 8px; }
        .btn-danger { background: #fee2e2; color: #b91c1c; border: none; border-radius: 8px; padding: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 13px; margin-top: 8px; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0">Symptom Mapper</h2>
        <div class="version-tag">v1.2.0 | IMPORT + EDIT</div>
    </div>

    <div class="config-row">
        <span>Check-in Interval:</span>
        <span><input type="number" id="remind-min" class="input-mini" value="15"> mins</span>
    </div>

    <div class="controls">
        <button id="btn-mode" onclick="toggleMode()">Mode: Log</button>
        <button onclick="toggleView()" style="background:#7c3aed">Flip Body</button>
        <button onclick="exportCSV()">Export</button>
        <button onclick="openImport()" style="background:#0891b2">Import</button>
        <button onclick="resetData()" style="background:#ef4444">Reset</button>
    </div>

    <div class="body-canvas" id="canvas-container">
        <svg viewBox="0 0 200 400">
            <g id="view-front">
                <path id="head-left" class="body-part" d="M100,20 Q70,20 70,50 L100,50 Z" onclick="doTap('Head Left')" />
                <rect id="head-center" class="body-part" x="90" y="20" width="20" height="30" onclick="doTap('Head Center')" />
                <path id="head-right" class="body-part" d="M100,20 Q130,20 130,50 L100,50 Z" onclick="doTap('Head Right')" />
                <rect id="neck-throat" class="body-part" x="85" y="55" width="30" height="15" rx="2" onclick="doTap('Neck / Throat')" />
                <rect id="chest-left" class="body-part" x="50" y="75" width="40" height="70" rx="5" onclick="doTap('Chest Left')" />
                <rect id="chest-center" class="body-part" x="90" y="75" width="20" height="70" onclick="doTap('Chest Center')" />
                <rect id="chest-right" class="body-part" x="110" y="75" width="40" height="70" rx="5" onclick="doTap('Chest Right')" />
                <rect id="abdomen-left" class="body-part" x="55" y="145" width="35" height="50" onclick="doTap('Abdomen Left')" />
                <rect id="abdomen-center" class="body-part" x="90" y="145" width="20" height="50" onclick="doTap('Abdomen Center')" />
                <rect id="abdomen-right" class="body-part" x="110" y="145" width="35" height="50" onclick="doTap('Abdomen Right')" />
                <rect id="groin-left" class="body-part" x="65" y="195" width="25" height="35" onclick="doTap('Groin Left')" />
                <rect id="groin-center" class="body-part" x="90" y="195" width="20" height="35" onclick="doTap('Groin Center')" />
                <rect id="groin-right" class="body-part" x="110" y="195" width="25" height="35" onclick="doTap('Groin Right')" />
                <path id="left-arm" class="body-part" d="M50,80 Q20,80 20,110 L35,210 Q45,220 55,210 Z" onclick="doTap('Left Arm')" />
                <path id="right-arm" class="body-part" d="M150,80 Q180,80 180,110 L165,210 Q155,220 145,210 Z" onclick="doTap('Right Arm')" />
                <path id="left-leg" class="body-part" d="M65,230 L90,230 L90,360 Q75,375 60,360 Z" onclick="doTap('Left Leg')" />
                <path id="right-leg" class="body-part" d="M110,230 L135,230 L135,360 Q120,375 105,360 Z" onclick="doTap('Right Leg')" />
            </g>
            <g id="view-back">
                <rect id="spine" class="body-part" x="88" y="70" width="24" height="160" onclick="doTap('Spine')" />
                <rect id="back-left-top" class="body-part" x="45" y="70" width="43" height="50" onclick="doTap('Back Left Top')" />
                <rect id="back-right-top" class="body-part" x="112" y="70" width="43" height="50" onclick="doTap('Back Right Top')" />
                <rect id="back-left-mid" class="body-part" x="48" y="120" width="40" height="50" onclick="doTap('Back Left Mid')" />
                <rect id="back-right-mid" class="body-part" x="112" y="120" width="40" height="50" onclick="doTap('Back Right Mid')" />
                <rect id="back-left-low" class="body-part" x="50" y="170" width="38" height="60" onclick="doTap('Back Left Low')" />
                <rect id="back-right-low" class="body-part" x="112" y="170" width="38" height="60" onclick="doTap('Back Right Low')" />
                <rect id="left-glute" class="body-part" x="50" y="230" width="45" height="55" rx="15" onclick="doTap('Left Glute')" />
                <rect id="right-glute" class="body-part" x="105" y="230" width="45" height="55" rx="15" onclick="doTap('Right Glute')" />
            </g>
        </svg>
    </div>

    <div id="list-active" style="width:100%; max-width:320px;"></div>
    <div id="list-history" style="width:100%; max-width:320px; margin-top:10px;"></div>

    <div id="status-log">LOG: Waiting for entry...</div>

    <div id="pop" class="modal">
        <div class="modal-content">
            <h3 id="pop-title" style="margin:0 0 15px 0">Symptom Log</h3>
            <p style="margin:0">Intensity: <span id="int-val" style="font-weight:bold; color:var(--primary)">5</span>/10</p>
            <input type="range" id="int-slide" min="1" max="10" value="5" oninput="document.getElementById('int-val').innerText=this.value">
            
            <div style="margin-top:15px;">
                <label><input type="checkbox" id="toggle-type"> Pain Description</label>
                <div id="drawer-type" class="drawer descriptor-grid">
                    <label><input type="checkbox" class="p-type" value="Aching"> Aching</label>
                    <label><input type="checkbox" class="p-type" value="Sharp"> Sharp</label>
                    <label><input type="checkbox" class="p-type" value="Burning"> Burning</label>
                    <label><input type="checkbox" class="p-type" value="Dull"> Dull</label>
                    <label><input type="checkbox" class="p-type" value="Thumping"> Thumping</label>
                    <label><input type="checkbox" class="p-type" value="Stabbing"> Stabbing</label>
                    <label><input type="checkbox" class="p-type" value="Tingling"> Tingling</label>
                    <label><input type="checkbox" class="p-type" value="Cramping"> Cramping</label>
                </div>
            </div>

            <div style="margin-top:10px;">
                <label><input type="checkbox" id="toggle-time"> <span id="label-time">Set Start Time</span></label>
                <div id="drawer-time" class="drawer">
                    <div id="slider-wrap">
                        <p style="margin:0">Began at: <span id="time-preview" style="font-weight:bold; color:var(--primary)">Now</span></p>
                        <input type="range" id="time-slider" class="rev-slider" min="0" max="24" value="0" step="1" oninput="updateActiveSlider(this.value)">
                        <div style="display:flex; justify-content: space-between; font-size: 10px; color: #94a3b8;">
                            <span>Now</span><span>12h Ago</span>
                        </div>
                    </div>

                    <div id="boxes-wrap" style="display:none;">
                        <p style="margin:5px 0; font-size:11px; color:#64748b;">START TIME</p>
                        <div class="time-select-row">
                            <select id="start-h"></select> : 
                            <select id="start-m"><option value="0">00</option><option value="30">30</option></select>
                            <select id="start-ap"><option>AM</option><option>PM</option></select>
                        </div>
                        <p style="margin:15px 0 5px 0; font-size:11px; color:#64748b;">END TIME</p>
                        <div class="time-select-row">
                            <select id="end-h"></select> : 
                            <select id="end-m"><option value="0">00</option><option value="30">30</option></select>
                            <select id="end-ap"><option>AM</option><option>PM</option></select>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top:10px;">
                <label><input type="checkbox" id="toggle-notes"> Add Notes</label>
                <div id="drawer-notes" class="drawer">
                    <textarea id="pop-notes" rows="2" placeholder="Any specific details?"></textarea>
                </div>
            </div>

            <button style="background:var(--primary); width:100%; margin-top:20px; padding:12px; font-weight:bold; color:white; border-radius:8px; border:none;" onclick="confirmLog()">Save</button>
            <button onclick="closePop()" style="width:100%; margin-top:10px; background:#e2e8f0; color:#475569; padding:10px; border-radius:8px; border:none;">Cancel</button>
        </div>
    </div>

    <!-- IMPORT MODAL -->
    <div id="import-modal" class="import-modal">
        <div class="import-content">
            <h3 style="margin:0 0 4px 0">Import Symptom Data</h3>
            <p style="margin:0 0 16px 0; font-size:12px; color:#64748b;">Upload a CSV, Excel (.xlsx), or Word (.docx) file from your previous tracking. Claude will intelligently parse the data and map it to the app's format.</p>

            <!-- STEP 1: File Pick -->
            <div id="import-step-1" class="import-step active">
                <div class="import-drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" accept=".csv,.xlsx,.xls,.docx" onchange="handleFileSelect(this.files[0])">
                    <div style="font-size:2rem; margin-bottom:8px;">üìÇ</div>
                    <div style="font-weight:bold; color:#334155;">Tap to choose file</div>
                    <div style="font-size:11px; color:#94a3b8; margin-top:4px;">CSV ¬∑ XLSX ¬∑ DOCX supported</div>
                </div>
                <div class="import-status" id="step1-status"></div>
                <button class="btn-secondary" onclick="closeImport()">Cancel</button>
            </div>

            <!-- STEP 2: Parsing / AI synthesis -->
            <div id="import-step-2" class="import-step">
                <div style="text-align:center; padding: 20px 0;">
                    <div style="font-size:2rem; margin-bottom:12px;">ü§ñ</div>
                    <div style="font-weight:bold; margin-bottom:8px;">Analyzing your data‚Ä¶</div>
                    <div class="import-status" id="step2-status" style="text-align:center;"></div>
                </div>
            </div>

            <!-- STEP 3: Preview parsed results -->
            <div id="import-step-3" class="import-step">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <strong id="preview-title">Preview</strong>
                    <span id="preview-badge" class="badge badge-ok"></span>
                </div>
                <div style="overflow-x:auto;">
                    <table class="preview-table" id="preview-table">
                        <thead><tr>
                            <th>Body Part</th><th>Intensity</th><th>Start</th><th>Duration</th><th>Types</th><th>Notes</th><th>Status</th>
                        </tr></thead>
                        <tbody id="preview-body"></tbody>
                    </table>
                </div>
                <div class="import-status" id="step3-status" style="margin-top:10px;"></div>
                
                <p style="font-size:12px; font-weight:bold; margin:14px 0 6px 0;">How should this be imported?</p>
                <div class="merge-option">
                    <input type="radio" id="opt-merge" name="import-mode" value="merge" checked>
                    <label for="opt-merge">‚ûï Merge<br><small style="font-weight:normal; color:#64748b;">Add to existing data</small></label>
                    <input type="radio" id="opt-replace" name="import-mode" value="replace">
                    <label for="opt-replace">üîÑ Replace<br><small style="font-weight:normal; color:#64748b;">Clear & reload</small></label>
                </div>

                <button class="btn-primary" onclick="commitImport()">Import Data</button>
                <button class="btn-secondary" onclick="goToStep(1)">‚Üê Try Different File</button>
                <button class="btn-secondary" onclick="closeImport()">Cancel</button>
            </div>

            <!-- STEP 4: Done -->
            <div id="import-step-4" class="import-step">
                <div style="text-align:center; padding: 20px 0;">
                    <div style="font-size:2.5rem; margin-bottom:12px;">‚úÖ</div>
                    <div style="font-weight:bold; font-size:1.1rem; margin-bottom:6px;" id="done-title">Import Complete</div>
                    <div class="import-status success" id="done-status" style="text-align:center;"></div>
                </div>
                <button class="btn-primary" onclick="closeImport()">Done</button>
            </div>
        </div>
    </div>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Mammoth for Word doc parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        // ‚îÄ‚îÄ‚îÄ IMPORT GLOBALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let parsedImportRows = [];

        const BODY_PARTS = [
            'Head Left','Head Center','Head Right','Neck / Throat',
            'Chest Left','Chest Center','Chest Right',
            'Abdomen Left','Abdomen Center','Abdomen Right',
            'Groin Left','Groin Center','Groin Right',
            'Left Arm','Right Arm','Left Leg','Right Leg',
            'Spine','Back Left Top','Back Right Top',
            'Back Left Mid','Back Right Mid','Back Left Low','Back Right Low',
            'Left Glute','Right Glute','Left Hamstring','Right Hamstring',
            'Left Calf','Right Calf'
        ];

        const PAIN_TYPES = ['Aching','Sharp','Burning','Dull','Thumping','Stabbing','Tingling','Cramping'];

        // ‚îÄ‚îÄ‚îÄ MODAL NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openImport() {
            goToStep(1);
            document.getElementById('import-modal').style.display = 'flex';
        }

        function closeImport() {
            document.getElementById('import-modal').style.display = 'none';
            parsedImportRows = [];
            document.getElementById('file-input').value = '';
        }

        function goToStep(n) {
            for(let i = 1; i <= 4; i++) {
                const el = document.getElementById(`import-step-${i}`);
                el.classList.toggle('active', i === n);
            }
        }

        // ‚îÄ‚îÄ‚îÄ DRAG AND DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFileSelect(e.dataTransfer.files[0]); });

        // ‚îÄ‚îÄ‚îÄ FILE SELECTION & PARSING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function handleFileSelect(file) {
            if (!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            const status = document.getElementById('step1-status');

            if (!['csv','xlsx','xls','docx'].includes(ext)) {
                status.textContent = '‚ö†Ô∏è Unsupported file type. Use CSV, XLSX, or DOCX.';
                status.className = 'import-status error';
                return;
            }

            status.innerHTML = '<span class="spinner"></span> Reading file‚Ä¶';
            status.className = 'import-status';
            goToStep(2);

            try {
                let rawText = '';

                if (ext === 'csv') {
                    rawText = await file.text();
                } else if (ext === 'xlsx' || ext === 'xls') {
                    const buf = await file.arrayBuffer();
                    const wb = XLSX.read(buf, { type: 'array', cellDates: true });
                    // Convert all sheets to CSV text
                    rawText = wb.SheetNames.map(name => {
                        const ws = wb.Sheets[name];
                        return `=== Sheet: ${name} ===\n` + XLSX.utils.sheet_to_csv(ws);
                    }).join('\n\n');
                } else if (ext === 'docx') {
                    const buf = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: buf });
                    rawText = result.value;
                }

                // Truncate very large files to avoid token limits
                const MAX_CHARS = 12000;
                const truncated = rawText.length > MAX_CHARS;
                const textToSend = truncated ? rawText.slice(0, MAX_CHARS) + '\n\n[...truncated for analysis]' : rawText;

                document.getElementById('step2-status').innerHTML = '<span class="spinner"></span> Sending to Claude for analysis‚Ä¶';
                await synthesizeWithAI(textToSend, file.name, truncated);

            } catch(err) {
                goToStep(1);
                const s = document.getElementById('step1-status');
                s.textContent = `‚ùå Error reading file: ${err.message}`;
                s.className = 'import-status error';
            }
        }

        // ‚îÄ‚îÄ‚îÄ AI SYNTHESIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function synthesizeWithAI(rawText, filename, wasTruncated) {
            const today = new Date().toISOString().slice(0,10);
            const prompt = `You are a medical data parser. The user has historical symptom tracking data from a file called "${filename}". Your job is to extract symptom entries and convert them to a structured JSON format.

Today's date is ${today}. Use this to resolve relative dates.

The app tracks symptoms on a human body map. Valid body parts are ONLY from this list:
${BODY_PARTS.join(', ')}

For body part matching: map any description to the closest valid part (e.g. "lower back left" ‚Üí "Back Left Low", "knee" ‚Üí "Left Leg" or "Right Leg", "head" ‚Üí "Head Center", "neck" ‚Üí "Neck / Throat", "stomach" ‚Üí "Abdomen Center", "shoulder" ‚Üí map to nearest arm/back part).

Valid pain types (can be multiple): ${PAIN_TYPES.join(', ')}

For each symptom entry found, output a JSON array. Each entry must have:
- "part": string (must be from valid body parts list)
- "val": integer 1-10 (intensity/severity ‚Äî infer from text like "mild"=2-3, "moderate"=5-6, "severe"=8-9; if number given use it)
- "start": ISO 8601 datetime string (infer from any date/time info; if only date given use 09:00; if no date use a reasonable estimate based on context)
- "end": ISO 8601 datetime string or null (null if still active/unknown)
- "types": array of strings from valid pain types (empty array if unknown)
- "notes": string (any additional notes, original description, context ‚Äî be generous here)
- "confidence": "high" | "medium" | "low" (how confident you are in this mapping)
- "originalText": string (the raw text fragment this was parsed from, max 80 chars)

Rules:
- Skip entries that have no discernible body location
- If intensity is completely unclear, use 5
- Be generous ‚Äî err on the side of including entries rather than skipping
- Return ONLY valid JSON array, no markdown, no explanation, nothing else

Raw data to parse:
${rawText}`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'API error');
                }

                const text = result.content.map(b => b.text || '').join('');
                const clean = text.replace(/```json|```/g, '').trim();
                const rows = JSON.parse(clean);

                if (!Array.isArray(rows)) throw new Error('Expected array from AI');

                parsedImportRows = rows;
                showPreview(rows, wasTruncated);

            } catch(err) {
                goToStep(1);
                const s = document.getElementById('step1-status');
                s.innerHTML = `‚ùå Analysis failed: ${err.message}<br><small>Check that your file has readable symptom data.</small>`;
                s.className = 'import-status error';
            }
        }

        // ‚îÄ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showPreview(rows, wasTruncated) {
            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = '';

            const ok = rows.filter(r => r.confidence !== 'low').length;
            const total = rows.length;

            document.getElementById('preview-title').textContent = `${total} entries found`;
            const badge = document.getElementById('preview-badge');
            badge.textContent = `${ok} ready`;
            badge.className = `badge ${ok === total ? 'badge-ok' : ok > 0 ? 'badge-warn' : 'badge-err'}`;

            rows.forEach((r, i) => {
                const tr = document.createElement('tr');
                if (r.confidence === 'low') tr.className = 'preview-row-skip';

                const startDate = r.start ? new Date(r.start) : null;
                const endDate = r.end ? new Date(r.end) : null;
                const startStr = startDate ? startDate.toLocaleDateString([], {month:'short',day:'numeric'}) + ' ' + startDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '?';
                const durationStr = (startDate && endDate) ? getDuration(startDate.getTime(), endDate.getTime()) : (r.end ? 'ended' : 'open');

                const confidenceBadge = {
                    'high': '<span class="badge badge-ok">‚úì</span>',
                    'medium': '<span class="badge badge-warn">~</span>',
                    'low': '<span class="badge badge-err">?</span>'
                }[r.confidence] || '';

                tr.innerHTML = `
                    <td><strong>${r.part}</strong><br><small style="color:#94a3b8; font-size:9px;">${(r.originalText||'').slice(0,40)}</small></td>
                    <td style="text-align:center;">${r.val}/10</td>
                    <td>${startStr}</td>
                    <td>${durationStr}</td>
                    <td style="font-size:10px;">${(r.types||[]).join(', ') || '‚Äî'}</td>
                    <td style="font-size:10px; max-width:80px; word-break:break-word;">${(r.notes||'').slice(0,60)}</td>
                    <td style="text-align:center;">${confidenceBadge}</td>
                `;
                tbody.appendChild(tr);
            });

            let statusMsg = '';
            if (wasTruncated) statusMsg += '‚ö†Ô∏è File was large ‚Äî only first portion was analyzed. ';
            if (rows.filter(r => r.confidence === 'low').length > 0) statusMsg += `${rows.filter(r=>r.confidence==='low').length} low-confidence entries (strikethrough) will be skipped.`;

            document.getElementById('step3-status').textContent = statusMsg;
            goToStep(3);
        }

        // ‚îÄ‚îÄ‚îÄ COMMIT IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function commitImport() {
            const importMode = document.querySelector('input[name="import-mode"]:checked').value;
            const toImport = parsedImportRows.filter(r => r.confidence !== 'low');

            const newEntries = toImport.map(r => ({
                id: Date.now() + Math.random(),
                part: r.part,
                val: Math.max(1, Math.min(10, parseInt(r.val) || 5)),
                start: r.start ? new Date(r.start).getTime() : Date.now(),
                end: r.end ? new Date(r.end).getTime() : null,
                lastCheck: Date.now(),
                types: Array.isArray(r.types) ? r.types : [],
                notes: r.notes || '',
                imported: true
            }));

            if (importMode === 'replace') {
                data = newEntries;
            } else {
                // Merge: deduplicate by checking for very similar entries
                data = [...data, ...newEntries];
            }

            // Sort by most recent first
            data.sort((a, b) => b.start - a.start);
            save();
            render();

            document.getElementById('done-title').textContent = importMode === 'replace' ? 'Data Replaced' : 'Data Merged';
            document.getElementById('done-status').textContent = `${newEntries.length} entries imported successfully.`;
            logToBox(`Import: ${newEntries.length} entries ${importMode === 'replace' ? 'replaced' : 'merged'}`);
            goToStep(4);
        }
    </script>

    <script>
        const KEY = 'symp_v100_final';
        let mode = 'log'; let view = 'front'; let activePart = ''; let editingId = null;
        let data = JSON.parse(localStorage.getItem(KEY)) || [];

        // UI HELPERS
        function logToBox(msg) {
            const box = document.getElementById('status-log');
            box.innerHTML += `<br>[${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}] ${msg}`;
            box.scrollTop = box.scrollHeight;
        }

        function fmtTime(ts) {
            return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function getDuration(s, e) { 
            const m = Math.max(1, Math.ceil(((e || Date.now()) - s) / 60000)); 
            return m > 60 ? `${Math.floor(m/60)}h ${m%60}m` : `${m}m`; 
        }

        // TIME SETUP
        const hs = ['start-h', 'end-h'];
        hs.forEach(id => {
            const el = document.getElementById(id);
            for(let i=1; i<=12; i++) el.innerHTML += `<option value="${i}">${i}</option>`;
        });

        ['type', 'time', 'notes'].forEach(id => {
            document.getElementById('toggle-'+id).onchange = (e) => {
                document.getElementById('drawer-'+id).style.display = e.target.checked ? 'block' : 'none';
            }
        });

        function getSnappedTime(offsetBlocks) {
            let d = new Date();
            d.setMinutes(Math.floor(d.getMinutes() / 30) * 30, 0, 0);
            return new Date(d.getTime() - (offsetBlocks * 30 * 60000));
        }

        function updateActiveSlider(val) {
            if(val == 0) { document.getElementById('time-preview').innerText = "Now"; return; }
            const target = getSnappedTime(val);
            document.getElementById('time-preview').innerText = target.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function setUITime(dateObj, prefix) {
            let h = dateObj.getHours();
            const m = dateObj.getMinutes();
            const ap = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            document.getElementById(`${prefix}-h`).value = h;
            document.getElementById(`${prefix}-m`).value = m < 30 ? "0" : "30";
            document.getElementById(`${prefix}-ap`).value = ap;
        }

        function getTimestampFromUI(prefix) {
            const h = parseInt(document.getElementById(`${prefix}-h`).value);
            const m = parseInt(document.getElementById(`${prefix}-m`).value);
            const ap = document.getElementById(`${prefix}-ap`).value;
            const d = new Date();
            let h24 = (ap === 'PM' && h < 12) ? h + 12 : (ap === 'AM' && h === 12) ? 0 : h;
            d.setHours(h24, m, 0, 0);
            return d.getTime();
        }

        // ACTIONS
        function doTap(name) {
            if (mode === 'heat') return;
            editingId = null; 
            activePart = name;
            document.getElementById('pop-title').innerText = name;
            document.getElementById('label-time').innerText = "Set Start Time";
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            document.querySelectorAll('.drawer').forEach(d => d.style.display = 'none');
            document.getElementById('slider-wrap').style.display = 'block';
            document.getElementById('boxes-wrap').style.display = 'none';
            document.getElementById('time-slider').value = 0;
            updateActiveSlider(0);
            document.getElementById('pop').style.display = 'flex';
        }

        function doEdit(id) {
            const item = data.find(x => x.id === id);
            if (!item) return;
            editingId = id;
            activePart = item.part;
            document.getElementById('pop-title').innerText = "Edit: " + item.part;
            document.getElementById('int-slide').value = item.val;
            document.getElementById('int-val').innerText = item.val;
            document.getElementById('pop-notes').value = item.notes || '';
            document.querySelectorAll('.p-type').forEach(cb => cb.checked = item.types.includes(cb.value));
            document.getElementById('toggle-time').checked = true;
            document.getElementById('drawer-time').style.display = 'block';

            if (item.end) {
                document.getElementById('label-time').innerText = "Change Time (Start/End)";
                document.getElementById('slider-wrap').style.display = 'none';
                document.getElementById('boxes-wrap').style.display = 'block';
                setUITime(new Date(item.start), 'start');
                setUITime(new Date(item.end), 'end');
            } else {
                document.getElementById('label-time').innerText = "Set Start Time";
                document.getElementById('slider-wrap').style.display = 'block';
                document.getElementById('boxes-wrap').style.display = 'none';
                const diffBlocks = Math.round((Date.now() - item.start) / (30 * 60000));
                document.getElementById('time-slider').value = Math.min(24, diffBlocks);
                updateActiveSlider(document.getElementById('time-slider').value);
            }
            document.getElementById('pop').style.display = 'flex';
        }

        function confirmLog() {
            const types = Array.from(document.querySelectorAll('.p-type:checked')).map(c => c.value);
            const notes = document.getElementById('toggle-notes').checked ? document.getElementById('pop-notes').value : "";
            let startTs, endTs = null;
            const original = editingId ? data.find(x => x.id === editingId) : null;

            if (original && original.end) {
                startTs = getTimestampFromUI('start');
                endTs = getTimestampFromUI('end');
            } else {
                const offset = document.getElementById('time-slider').value;
                if (offset == 0) startTs = original ? original.start : Date.now();
                else startTs = getSnappedTime(offset).getTime();
            }

            if (editingId) {
                const idx = data.findIndex(x => x.id === editingId);
                data[idx] = { ...data[idx], val: parseInt(document.getElementById('int-slide').value), types, notes, start: startTs, end: endTs };
                logToBox(`Updated: ${activePart}`);
            } else {
                data.unshift({ id: Date.now(), part: activePart, val: parseInt(document.getElementById('int-slide').value), start: startTs, lastCheck: Date.now(), end: null, notes, types });
                logToBox(`Logged: ${activePart}`);
            }
            save(); closePop(); render();
        }

        function render() {
            const activeDiv = document.getElementById('list-active');
            const historyDiv = document.getElementById('list-history');
            const actives = data.filter(x => !x.end);
            const pasts = data.filter(x => x.end);

            activeDiv.innerHTML = actives.length ? "<h4 style='margin:10px 0'>Active</h4>" + actives.map(x => `
                <div class="log-card active-card">
                    <strong>${x.part}</strong> (${x.val}/10)<br><small>${x.types.join(' ‚Ä¢ ')}</small>
                    <span style="display:block; font-size:0.75rem; color:var(--primary); font-weight:bold; margin-top:4px;">Began at: ${fmtTime(x.start)}</span>
                    <div style="display:flex; gap:5px; margin-top:8px;">
                        <button onclick="endLog(${x.id})" style="flex:2; background:#000; color:white; padding:8px; border-radius:5px; border:none; font-weight:bold;">End Now</button>
                        <button onclick="doEdit(${x.id})" style="flex:1; background:#64748b; color:white; padding:8px; border-radius:5px; border:none; font-weight:bold;">Edit</button>
                    </div>
                    <button class="del-btn" onclick="deleteItem(${x.id})">Del</button>
                </div>`).join('') : "";

            historyDiv.innerHTML = pasts.length ? "<h4 style='margin:10px 0'>History</h4>" + pasts.slice(0,10).map(x => `
                <div class="log-card">
                    <strong>${x.part}</strong> (${x.val}/10)<br>
                    <small style="display:block; margin-top:2px;">${fmtTime(x.start)} - ${fmtTime(x.end)} (${getDuration(x.start, x.end)})</small>
                    <button onclick="doEdit(${x.id})" style="width:100%; background:#64748b; color:white; padding:6px; border-radius:5px; border:none; font-size:11px; margin-top:8px;">Edit Details</button>
                    <button class="del-btn" onclick="deleteItem(${x.id})">Del</button>
                </div>`).join('') : "";
            applyHeat();
        }

        function closePop() { document.getElementById('pop').style.display = 'none'; editingId = null; }
        function endLog(id) { const i = data.find(x => x.id === id); if(i) { i.end = Date.now(); save(); render(); }}
        function deleteItem(id) { if(confirm("Delete?")) { data = data.filter(x => x.id !== id); save(); render(); }}
        function toggleMode() { mode = (mode === 'log') ? 'heat' : 'log'; document.body.classList.toggle('heat-mode-on', mode === 'heat'); document.getElementById('btn-mode').innerText = `Mode: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`; render(); }
        function toggleView() { view = (view === 'front') ? 'back' : 'front'; document.getElementById('canvas-container').classList.toggle('showing-back'); render(); }
        function applyHeat() { 
            document.querySelectorAll('.body-part').forEach(el => el.classList.remove('heat-low', 'heat-med', 'heat-high'));
            if(mode !== 'heat') return;
            const scores = {};
            data.forEach(x => { const id = x.part.toLowerCase().replace(/ \/ /g, '-').replace(/ /g, '-'); if(!scores[id]) scores[id] = []; scores[id].push(x.val); });
            for(let id in scores) {
                const avg = scores[id].reduce((a,b) => a+b, 0) / scores[id].length;
                const el = document.getElementById(id);
                if(el) { if(avg >= 7) el.classList.add('heat-high'); else if(avg >= 4) el.classList.add('heat-med'); else el.classList.add('heat-low'); }
            }
        }
        function save() { localStorage.setItem(KEY, JSON.stringify(data)); }
        function resetData() { if(confirm("Clear data?")) { data = []; save(); render(); } }
        function exportCSV() {
            let csv = "Part,Intensity,Types,Notes,Start,End,Duration\n";
            data.forEach(x => csv += `"${x.part}",${x.val},"${x.types.join('|')}","${x.notes}","${new Date(x.start).toLocaleString()}","${x.end ? new Date(x.end).toLocaleString() : 'Active'}","${getDuration(x.start, x.end)}"\n`);
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='symptoms.csv'; a.click();
        }
        setInterval(render, 30000);
        render();
    </script>
</body>
</html>
